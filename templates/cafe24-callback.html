<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Cafe24 Callback</title>
</head>
<body>
    <h1>카페24 연동 처리 중...</h1>
    <p>잠시만 기다려 주세요.</p>

    <script>
        async function handleCafe24OAuthCallback() {
            console.log("카페24 콜백 페이지 로드됨.");
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const state = urlParams.get('state'); 

            if (code) {
                console.log("인증 코드(Code) 획득:", code);
                // 획득한 code를 사용했으므로, URL에서 code 파라미터를 제거하여 무한 루프 방지
                window.history.replaceState({}, document.title, window.location.pathname);
                
                const backendBaseUrl = "http://localhost:8080"; // <<<--- 중요: 백엔드 URL 설정
                try {
                    console.log("인증 코드를 백엔드로 전달 중...");
                    const response = await fetch(`${backendBaseUrl}/api/v1/oauth/cafe24/callback?code=${code}`, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                    });

                    if (!response.ok) {
                        const errorDetails = await response.text();
                        throw new Error(`백엔드 API 호출 실패: ${response.status} ${response.statusText} - ${errorDetails}`);
                    }
                    console.log("인증 코드를 백엔드로 성공적으로 전달했습니다.");
                    alert("카페24 연동이 성공적으로 완료되었습니다. 백엔드 로그를 확인하십시오.");
                    // 백엔드에서 Access Token 발급 후 프론트엔드의 성공 페이지로 리다이렉션할 것이므로
                    // 여기서는 추가적인 리다이렉션을 하지 않습니다.
                } catch (error) {
                    console.error("인증 코드를 백엔드로 전달 중 에러 발생:", error);
                    alert("카페24 연동 처리 중 오류가 발생했습니다: " + error.message);
                }
            } else {
                console.log("URL에서 인증 코드를 찾을 수 없습니다.");
                alert("카페24 연동에 실패했습니다. 인증 코드를 받지 못했습니다.");
                // 오류 발생 시 URL에서 code 파라미터가 이미 제거되었으므로, 추가 리다이렉션 없이 메시지 표시
            }
        }

        // 페이지 로드 시 콜백 핸들러 자동 실행
        document.addEventListener('DOMContentLoaded', handleCafe24OAuthCallback);
    </script>
</body>
</html>
