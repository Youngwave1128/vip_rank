<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Cafe24 Callback</title>
</head>
<body>
    <h1>카페24 연동 처리 중...</h1>
    <p>잠시만 기다려 주세요.</p>

    <script>
        async function handleCafe24OAuthCallback() {
            console.log("카페24 콜백 페이지 로드됨.");
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const state = urlParams.get('state'); 

            if (code) {
                console.log("인증 코드(Code) 획득:", code);
                const backendBaseUrl = "http://localhost:8080"; // <<<--- 중요: 백엔드 URL 설정
                try {
                    // **수정된 부분: window.location.href 대신 fetch (POST) 요청 사용**
                    // 백엔드의 /api/v1/oauth/cafe24/callback 엔드포인트는 GET으로 되어 있지만,
                    // HTTPS -> HTTP 요청의 보안 문제를 회피하기 위해 프론트엔드에서 POST로 보내고,
                    // 백엔드의 @GetMapping("/callback")을 @PostMapping("/callback")으로 변경하는 것을 고려합니다.
                    // 일단은 GET 요청으로 유지하되, 백엔드에서 @GetMapping 대신 @PostMapping을 사용하도록 변경할 수 있습니다.
                    // 여기서는 GET 요청을 URL 파라미터로 보냅니다. (이전과 동일한 백엔드 엔드포인트 시그니처 가정)
                    const response = await fetch(`${backendBaseUrl}/api/v1/oauth/cafe24/callback?code=${code}`, {
                        method: 'GET', // 백엔드 Cafe24OAuthController의 @GetMapping과 일치
                        headers: {
                            'Content-Type': 'application/json',
                            // CORS 문제를 피하기 위해 추가 헤더는 최소화
                        },
                    });
                    if (!response.ok) {
                        const errorDetails = await response.text();
                        throw new Error(`백엔드 API 호출 실패: ${response.status} ${response.statusText} - ${errorDetails}`);
                    }
                    console.log("인증 코드를 백엔드로 성공적으로 전달했습니다.");
                    // 백엔드가 RedirectView를 통해 사용자를 다시 리다이렉션할 것이므로,
                    // 프론트엔드에서 추가적인 window.location.href 변경은 필요 없습니다.
                    // 성공 또는 오류 페이지는 백엔드 RedirectView에 의해 결정됩니다.
                    alert("카페24 연동 처리 중. 백엔드의 최종 리다이렉션을 기다립니다.");
                } catch (error) {
                    console.error("인증 코드를 백엔드로 전달 중 에러 발생:", error);
                    alert("카페24 연동 처리 중 오류가 발생했습니다: " + error.message);
                    window.location.href = "/"; // 오류 발생 시 홈으로 이동 (백엔드 리다이렉션 실패 가정)
                }        } else {
                console.error("URL에서 인증 코드를 찾을 수 없습니다.");
                alert("카페24 연동에 실패했습니다. 인증 코드를 받지 못했습니다.");
                window.location.href = "/"; // 오류 발생 시 홈으로 이동
            }
        }

        document.addEventListener('DOMContentLoaded', handleCafe24OAuthCallback);
    </script>
</body>
</html>
